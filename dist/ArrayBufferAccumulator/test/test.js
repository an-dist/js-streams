"use strict";import{ArrayBufferAccumulator as c}from"../ArrayBufferAccumulator.js";import{CompatiblePerformance as w}from"../../misc/CompatiblePerformance/CompatiblePerformance.js";import{PerformanceStreamBuilder as A}from"../../PerformanceStream/PerformanceStream.js";import{Utf8DecoderStream as T,Utf8EncoderStream as W}from"../../Utf8Streams/Utf8Streams.js";import{sleep as O}from"../../funcs/sleep/sleep.js";(async()=>{w.replaceIfUnsupported();function l(r,e,o){return new ReadableStream({start(t){const n=new ArrayBuffer(r),i=n.byteLength/e;for(let s=0;s<i;++s){const a=new Uint8Array(n.slice(s*e,s*e+e));if(o){const y=Array.from(a.values());t.enqueue(y)}else t.enqueue(a)}t.close()}})}function f(r){return new WritableStream({write(e){Array.isArray(e)?r.sizeOfWritten+=e.length:r.sizeOfWritten+=e.byteLength}})}function m(r,e){return new TransformStream({transform(o,t){let n;Array.isArray(o)?n=o.length:n=o.byteLength,console.assert([r,e,r-e*Math.floor(r/e)].indexOf(n)!==-1,{receivedChunkSize:n}),t.enqueue(o)}})}const p=async(r,e,o,t,n)=>{e=e===0?r:e;const i=new A("ArrayBufferAccumulator","start","end"),s={sizeOfWritten:0};await l(r,e,n).pipeThrough(i.pipe(new c(o,{fixed:t}).transform()).build()).pipeThrough(m(r,o)).pipeTo(f(s));const a=i.result();console.assert(a!==void 0),console.groupCollapsed([`ReadableStream(${r.toLocaleString()}, { isArray: ${n} }) =>`,`chunk(${e.toLocaleString()}) =>`,`ArrayBufferAccumulator(${o.toLocaleString()}, { fixed: ${t} })`,`durationOfOccupancy: ${a.occupancy}`].join(" ")),console.assert((t?o*Math.ceil(r/o):r)===s.sizeOfWritten,{sizeOfWritten:s.sizeOfWritten}),console.table({totalSize:r,readableChunkSize:e,chunkSize:o,sizeOfWritten:s.sizeOfWritten,transforming:a.transforming,durationOfOccupancy:a.occupancy,durationMinimum:a.maximum,durationMaximum:a.maximum,durationAverage:a.average,durationMedian:a.median}),console.groupEnd(),await O()},u=async r=>{const e=`aaaaaaaaaa
bbbbbbbbbb
cccccccccc
dddddddddd
eeeeeeeeee
11111`,o=new ReadableStream({start(n){n.enqueue(e),n.close()}}),t=new WritableStream({write(n){console.log(`[${n}]`)}});await o.pipeThrough(new W).pipeThrough(new c(r,{forceEmit:[[10,13],[13],[10]]}).transform()).pipeThrough(new T).pipeTo(t)};await l(1,1,!1).pipeThrough(new c(1).transform()).pipeTo(new WritableStream);const d=[1,1e3,1*1024*1024],b=[64,1e3,8192,8192*10,0],g=[128,256,512,1e3,8192];console.groupCollapsed("Testing ArrayBuffer|Array");for(const r of d){console.groupCollapsed(`totalSize: ${r}`);for(const e of b)for(const o of g)for(const t of[!1,!0])for(const n of[!1,!0])await p(r,e,o,t,n);console.groupEnd()}console.groupEnd(),console.groupCollapsed("Testing line separate"),console.groupCollapsed("> size"),await u(8),console.groupEnd(),console.groupCollapsed("= size"),await u(10),console.groupEnd(),console.groupCollapsed("< size"),await u(13),console.groupEnd(),console.groupEnd(),console.log("Test completed.")})();
//# sourceMappingURL=test.js.map
