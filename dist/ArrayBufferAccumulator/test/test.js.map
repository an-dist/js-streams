{
  "version": 3,
  "sources": ["test.ts"],
  "sourcesContent": ["import { ArrayBufferAccumulator } from \"../ArrayBufferAccumulator.ts\"\r\nimport { PerformanceStreamBuilder } from \"../../PerformanceStream/PerformanceStream.ts\"\r\nimport { Utf8DecoderStream, Utf8EncoderStream } from \"../../Utf8Streams/Utf8Streams.ts\"\r\nimport { sleep } from \"../../funcs/sleep/sleep.ts\"\r\n\r\nfunction source(totalSize: number, chunkSize: number, isArray: boolean) {\r\n  return new ReadableStream<Uint8Array | Array<number>>({\r\n    start(controller) {\r\n      const bytes = new ArrayBuffer(totalSize)\r\n      const count = bytes.byteLength / chunkSize\r\n      for (let i = 0; i < count; ++i) {\r\n        const bytesView = new Uint8Array(bytes.slice(i * chunkSize, i * chunkSize + chunkSize))\r\n        if (isArray) {\r\n          const array = Array.from(bytesView.values())\r\n          controller.enqueue(array)\r\n        }\r\n        else {\r\n          controller.enqueue(bytesView)\r\n        }\r\n      }\r\n      controller.close()\r\n    }\r\n  })\r\n}\r\n\r\ninterface WritableResult {\r\n  sizeOfWritten: number\r\n}\r\n\r\nfunction results<T extends ArrayBufferLike | ArrayLike<any>>(result: WritableResult) {\r\n  return new WritableStream<T>({\r\n    write(chunk) {\r\n      if (Array.isArray(chunk)) {\r\n        result.sizeOfWritten += chunk.length\r\n      }\r\n      else {\r\n        result.sizeOfWritten += (chunk as ArrayBufferLike).byteLength\r\n      }\r\n    }\r\n  })\r\n}\r\n\r\nfunction assertChunkSize<T extends ArrayBufferLike | ArrayLike<any>>(totalSize: number, chunkSize: number) {\r\n  return new TransformStream<T, T>({\r\n    transform(chunk, controller) {\r\n      let length: number\r\n      if (Array.isArray(chunk)) {\r\n        length = chunk.length\r\n      }\r\n      else {\r\n        length = (chunk as ArrayBufferLike).byteLength\r\n      }\r\n      console.assert([\r\n        totalSize,\r\n        chunkSize,\r\n        totalSize - (chunkSize * Math.floor(totalSize / chunkSize)),\r\n      ].indexOf(length) !== -1, {\r\n        receivedChunkSize: length,\r\n      })\r\n      controller.enqueue(chunk)\r\n    }\r\n  })\r\n}\r\n\r\nconst test = async (totalSize: number, readableChunkSize: number, chunkSize: number, fixed: boolean, isArray: boolean) => {\r\n  readableChunkSize = readableChunkSize === 0 ? totalSize : readableChunkSize\r\n\r\n  const builder = new PerformanceStreamBuilder<Uint8Array | number[], Uint8Array | number[]>(\"ArrayBufferAccumulator\", \"start\", \"end\")\r\n  const result: WritableResult = { sizeOfWritten: 0 }\r\n\r\n  await source(totalSize, readableChunkSize, isArray)\r\n    .pipeThrough(builder\r\n      .pipe(new ArrayBufferAccumulator(chunkSize, { fixed }).transform())\r\n      .build())\r\n    .pipeThrough(assertChunkSize(totalSize, chunkSize))\r\n    .pipeTo(results(result))\r\n\r\n  const psResult = builder.result()\r\n  console.assert(psResult !== undefined)\r\n\r\n  console.groupCollapsed([\r\n    `ReadableStream(${totalSize.toLocaleString()}, { isArray: ${isArray} }) =>`,\r\n    `chunk(${readableChunkSize.toLocaleString()}) =>`,\r\n    `ArrayBufferAccumulator(${chunkSize.toLocaleString()}, { fixed: ${fixed} })`,\r\n    `durationOfOccupancy: ${psResult!.occupancy}`,\r\n  ].join(\" \"))\r\n\r\n  console.assert((fixed\r\n    ? chunkSize * Math.ceil(totalSize / chunkSize)\r\n    : totalSize) === result.sizeOfWritten, {\r\n    sizeOfWritten: result.sizeOfWritten,\r\n  })\r\n\r\n  console.table({\r\n    totalSize,\r\n    readableChunkSize,\r\n    chunkSize,\r\n    sizeOfWritten: result.sizeOfWritten,\r\n    transforming: psResult!.transforming,\r\n    durationOfOccupancy: psResult!.occupancy,\r\n    durationMinimum: psResult!.maximum,\r\n    durationMaximum: psResult!.maximum,\r\n    durationAverage: psResult!.average,\r\n    durationMedian: psResult!.median,\r\n  })\r\n\r\n  console.groupEnd()\r\n\r\n  await sleep()\r\n}\r\n\r\nconst testNewLine = async (chunkSize: number) => {\r\n  const text = \"aaaaaaaaaa\\nbbbbbbbbbb\\ncccccccccc\\ndddddddddd\\neeeeeeeeee\\n11111\"\r\n\r\n  const readable = new ReadableStream<string>({\r\n    start(controller) {\r\n      controller.enqueue(text)\r\n      controller.close()\r\n    }\r\n  })\r\n\r\n  const writable = new WritableStream({\r\n    write(chunk) {\r\n      console.log(`[${chunk}]`)\r\n    }\r\n  })\r\n\r\n  await readable\r\n    .pipeThrough(new Utf8EncoderStream)\r\n    .pipeThrough(new ArrayBufferAccumulator(chunkSize, { forceEmit: [[10, 13], [13], [10]] }).transform())\r\n    .pipeThrough(new Utf8DecoderStream)\r\n    .pipeTo(writable)\r\n}\r\n\r\n// warmup\r\nawait source(1, 1, false)\r\n  .pipeThrough(new ArrayBufferAccumulator(1).transform())\r\n  .pipeTo(new WritableStream)\r\n\r\nconst totalSizes = [\r\n  1,\r\n  1000,\r\n  1 * 1024 * 1024,\r\n]\r\nconst readableChunkSizes = [\r\n  64,\r\n  1000,\r\n  8192,\r\n  8192 * 10,\r\n  0,\r\n]\r\nconst chunkSizes = [\r\n  128,\r\n  256,\r\n  512,\r\n  1000,\r\n  8192,\r\n]\r\n\r\nconsole.groupCollapsed(\"Testing ArrayBuffer|Array\")\r\nfor (const totalSize of totalSizes) {\r\n  console.groupCollapsed(`totalSize: ${totalSize}`)\r\n  for (const readableChunkSize of readableChunkSizes) {\r\n    for (const chunkSize of chunkSizes) {\r\n      for (const fixed of [false, true]) {\r\n        for (const isArray of [false, true]) {\r\n          await test(totalSize, readableChunkSize, chunkSize, fixed, isArray)\r\n        }\r\n      }\r\n    }\r\n  }\r\n  console.groupEnd()\r\n}\r\nconsole.groupEnd()\r\n\r\nconsole.groupCollapsed(\"Testing line separate\")\r\nconsole.groupCollapsed(\"> size\")\r\nawait testNewLine(8)\r\nconsole.groupEnd()\r\nconsole.groupCollapsed(\"= size\")\r\nawait testNewLine(10)\r\nconsole.groupEnd()\r\nconsole.groupCollapsed(\"< size\")\r\nawait testNewLine(13)\r\nconsole.groupEnd()\r\nconsole.groupEnd()\r\n\r\nconsole.log(\"Test completed.\")"],
  "mappings": "AAAA,SAAS,8BAA8B;AACvC,SAAS,gCAAgC;AACzC,SAAS,mBAAmB,yBAAyB;AACrD,SAAS,aAAa;AAEtB,SAAS,OAAO,WAAmB,WAAmB,SAAkB;AACtE,SAAO,IAAI,eAA2C;AAAA,IACpD,MAAM,YAAY;AAChB,YAAM,QAAQ,IAAI,YAAY,SAAS;AACvC,YAAM,QAAQ,MAAM,aAAa;AACjC,eAAS,IAAI,GAAG,IAAI,OAAO,EAAE,GAAG;AAC9B,cAAM,YAAY,IAAI,WAAW,MAAM,MAAM,IAAI,WAAW,IAAI,YAAY,SAAS,CAAC;AACtF,YAAI,SAAS;AACX,gBAAM,QAAQ,MAAM,KAAK,UAAU,OAAO,CAAC;AAC3C,qBAAW,QAAQ,KAAK;AAAA,QAC1B,OACK;AACH,qBAAW,QAAQ,SAAS;AAAA,QAC9B;AAAA,MACF;AACA,iBAAW,MAAM;AAAA,IACnB;AAAA,EACF,CAAC;AACH;AAMA,SAAS,QAAoD,QAAwB;AACnF,SAAO,IAAI,eAAkB;AAAA,IAC3B,MAAM,OAAO;AACX,UAAI,MAAM,QAAQ,KAAK,GAAG;AACxB,eAAO,iBAAiB,MAAM;AAAA,MAChC,OACK;AACH,eAAO,iBAAkB,MAA0B;AAAA,MACrD;AAAA,IACF;AAAA,EACF,CAAC;AACH;AAEA,SAAS,gBAA4D,WAAmB,WAAmB;AACzG,SAAO,IAAI,gBAAsB;AAAA,IAC/B,UAAU,OAAO,YAAY;AAC3B,UAAI;AACJ,UAAI,MAAM,QAAQ,KAAK,GAAG;AACxB,iBAAS,MAAM;AAAA,MACjB,OACK;AACH,iBAAU,MAA0B;AAAA,MACtC;AACA,cAAQ,OAAO;AAAA,QACb;AAAA,QACA;AAAA,QACA,YAAa,YAAY,KAAK,MAAM,YAAY,SAAS;AAAA,MAC3D,EAAE,QAAQ,MAAM,MAAM,IAAI;AAAA,QACxB,mBAAmB;AAAA,MACrB,CAAC;AACD,iBAAW,QAAQ,KAAK;AAAA,IAC1B;AAAA,EACF,CAAC;AACH;AAEA,MAAM,OAAO,OAAO,WAAmB,mBAA2B,WAAmB,OAAgB,YAAqB;AACxH,sBAAoB,sBAAsB,IAAI,YAAY;AAE1D,QAAM,UAAU,IAAI,yBAAuE,0BAA0B,SAAS,KAAK;AACnI,QAAM,SAAyB,EAAE,eAAe,EAAE;AAElD,QAAM,OAAO,WAAW,mBAAmB,OAAO,EAC/C,YAAY,QACV,KAAK,IAAI,uBAAuB,WAAW,EAAE,MAAM,CAAC,EAAE,UAAU,CAAC,EACjE,MAAM,CAAC,EACT,YAAY,gBAAgB,WAAW,SAAS,CAAC,EACjD,OAAO,QAAQ,MAAM,CAAC;AAEzB,QAAM,WAAW,QAAQ,OAAO;AAChC,UAAQ,OAAO,aAAa,MAAS;AAErC,UAAQ,eAAe;AAAA,IACrB,kBAAkB,UAAU,eAAe,CAAC,gBAAgB,OAAO;AAAA,IACnE,SAAS,kBAAkB,eAAe,CAAC;AAAA,IAC3C,0BAA0B,UAAU,eAAe,CAAC,cAAc,KAAK;AAAA,IACvE,wBAAwB,SAAU,SAAS;AAAA,EAC7C,EAAE,KAAK,GAAG,CAAC;AAEX,UAAQ,QAAQ,QACZ,YAAY,KAAK,KAAK,YAAY,SAAS,IAC3C,eAAe,OAAO,eAAe;AAAA,IACvC,eAAe,OAAO;AAAA,EACxB,CAAC;AAED,UAAQ,MAAM;AAAA,IACZ;AAAA,IACA;AAAA,IACA;AAAA,IACA,eAAe,OAAO;AAAA,IACtB,cAAc,SAAU;AAAA,IACxB,qBAAqB,SAAU;AAAA,IAC/B,iBAAiB,SAAU;AAAA,IAC3B,iBAAiB,SAAU;AAAA,IAC3B,iBAAiB,SAAU;AAAA,IAC3B,gBAAgB,SAAU;AAAA,EAC5B,CAAC;AAED,UAAQ,SAAS;AAEjB,QAAM,MAAM;AACd;AAEA,MAAM,cAAc,OAAO,cAAsB;AAC/C,QAAM,OAAO;AAEb,QAAM,WAAW,IAAI,eAAuB;AAAA,IAC1C,MAAM,YAAY;AAChB,iBAAW,QAAQ,IAAI;AACvB,iBAAW,MAAM;AAAA,IACnB;AAAA,EACF,CAAC;AAED,QAAM,WAAW,IAAI,eAAe;AAAA,IAClC,MAAM,OAAO;AACX,cAAQ,IAAI,IAAI,KAAK,GAAG;AAAA,IAC1B;AAAA,EACF,CAAC;AAED,QAAM,SACH,YAAY,IAAI,mBAAiB,EACjC,YAAY,IAAI,uBAAuB,WAAW,EAAE,WAAW,CAAC,CAAC,IAAI,EAAE,GAAG,CAAC,EAAE,GAAG,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,UAAU,CAAC,EACpG,YAAY,IAAI,mBAAiB,EACjC,OAAO,QAAQ;AACpB;AAGA,MAAM,OAAO,GAAG,GAAG,KAAK,EACrB,YAAY,IAAI,uBAAuB,CAAC,EAAE,UAAU,CAAC,EACrD,OAAO,IAAI,gBAAc;AAE5B,MAAM,aAAa;AAAA,EACjB;AAAA,EACA;AAAA,EACA,IAAI,OAAO;AACb;AACA,MAAM,qBAAqB;AAAA,EACzB;AAAA,EACA;AAAA,EACA;AAAA,EACA,OAAO;AAAA,EACP;AACF;AACA,MAAM,aAAa;AAAA,EACjB;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AACF;AAEA,QAAQ,eAAe,2BAA2B;AAClD,WAAW,aAAa,YAAY;AAClC,UAAQ,eAAe,cAAc,SAAS,EAAE;AAChD,aAAW,qBAAqB,oBAAoB;AAClD,eAAW,aAAa,YAAY;AAClC,iBAAW,SAAS,CAAC,OAAO,IAAI,GAAG;AACjC,mBAAW,WAAW,CAAC,OAAO,IAAI,GAAG;AACnC,gBAAM,KAAK,WAAW,mBAAmB,WAAW,OAAO,OAAO;AAAA,QACpE;AAAA,MACF;AAAA,IACF;AAAA,EACF;AACA,UAAQ,SAAS;AACnB;AACA,QAAQ,SAAS;AAEjB,QAAQ,eAAe,uBAAuB;AAC9C,QAAQ,eAAe,QAAQ;AAC/B,MAAM,YAAY,CAAC;AACnB,QAAQ,SAAS;AACjB,QAAQ,eAAe,QAAQ;AAC/B,MAAM,YAAY,EAAE;AACpB,QAAQ,SAAS;AACjB,QAAQ,eAAe,QAAQ;AAC/B,MAAM,YAAY,EAAE;AACpB,QAAQ,SAAS;AACjB,QAAQ,SAAS;AAEjB,QAAQ,IAAI,iBAAiB;",
  "names": []
}
